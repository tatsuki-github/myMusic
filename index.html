<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>メロディア</title>

    <script>
          document.write(
            '<link rel="stylesheet" href="css/style.css?' + new Date().getTime() + '">'
          );
    </script>
    <script src="https://unpkg.com/tone@14.7.77/build/Tone.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="js/abcjs-basic.js"></script>
    <script src="js/abcjs_midi_5.12.0-min.js"></script>

    <link rel="stylesheet" type="text/css" href="css/abcjs-audio.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css" integrity="sha512-1sCRPdkRXhBV2PBLUdRb4tMg1w2YPf37qatUFeS7zlBy7jJI8Lf4VHwWfZZfpXtYSLy85pkm9GaYVYMfw5BC1A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body onload="load()">

<div class="playSettings">
  <div class="buttons">
    <select name="tempo_category" id="tempo_category">
      <option value="tempo_60">&#9833; = 60</option>
      <option value="tempo_80">&#9833; = 80</option>
      <option value="tempo_100" selected>&#9833; = 100</option>
      <option value="tempo_120">&#9833; = 120</option>
      <option value="tempo_140">&#9833; = 140</option>
      <option value="tempo_160">&#9833; = 160</option>
    </select>
    <select name="play_mode" id="play_mode">
      <option value="play" selected>旋律・コード</option>
      <option value="only_melody">旋律のみ</option>
      <option value="only_chord">コードのみ</option>
    </select>
    <div id="audio" style="width:400px;"></div>  
  </div>
</div>

<div id="paper"></div>

<div class="beat">
  <label for="eighthNote">
    <input id="eighthNote" type="radio" name="beat" value="eighthNote">
    <img src="img/hatibuonpu.jpeg" alt="" class="rhythmImg" id="tata" ontouchstart="">
  </label>

  <label for="quarterNote">
    <input id="quarterNote" type="radio" name="beat" value="quarterNote" checked>
    <img src="img/shibuonnpu.jpeg" alt="" class="rhythmImg" id="tan" ontouchstart="">
  </label>

  <label for="dottedQuarterNote">
    <input id="dottedQuarterNote" type="radio" name="beat" value="dottedQuarterNote">
    <img src="img/huten-yonbuonpu.jpeg" alt="" class="rhythmImg" id="ta_n" ontouchstart="">
  </label>

  <label for="halfNote">
    <input id="halfNote" type="radio" name="beat" value="halfNote">
    <img src="img/nibunonpu.jpeg" alt="" class="rhythmImg" id="ta__n" ontouchstart="">
  </label>

  <img src="img/hachibukyufu.jpeg" alt="" class="rhythmImg" id="eighthRest" ontouchstart="">

  <img src="img/shibukyufu.jpeg" alt="" class="rhythmImg" id="quarterRest" ontouchstart="">

  <button id="oneBack" ontouchstart=""><i class="fa-solid fa-rotate-left"></i></button>

  <select name="measureEdit" id="measureEdit">
    <option value="measureEdit">編集モード</option>
    <option value="measure1">1小節目を編集</option>
    <option value="measure2">2小節目を編集</option>
    <option value="measure3">3小節目を編集</option>
    <option value="measure4">4小節目を編集</option>
    <option value="measure5">5小節目を編集</option>
    <option value="measure6">6小節目を編集</option>
    <option value="measure7">7小節目を編集</option>
    <option value="measure8">8小節目を編集</option>
  </select>
</div>

<div class="piano" id="piano">
  <div class="key white" id="do" ontouchstart=""><p>ド</p></div>
  <div class="black"></div>
  <div class="key white" id="re" ontouchstart=""><p>レ</p></div>
  <div class="black"></div>
  <div class="key white" id="mi" ontouchstart=""><p>ミ</p></div>
  <div class="key white" id="fa" ontouchstart=""><p>ファ</p></div>
  <div class="black"></div>
  <div class="key white" id="so" ontouchstart=""><p>ソ</p></div>
  <div class="black"></div>
  <div class="key white" id="ra" ontouchstart=""><p>ラ</p></div>
  <div class="black"></div>
  <div class="key white" id="shi" ontouchstart=""><p>シ</p></div>
  <div class="key white" id="do_high" ontouchstart=""><p>ド↑</p></div>
  <div class="black"></div>
  <div class="key white" id="re_high" ontouchstart=""><p>レ↑</p></div>
  <div class="black"></div>
  <div class="key white" id="mi_high" ontouchstart=""><p>ミ↑</p></div>
</div>
<script>

//ロード
function load(){
  for(i = 0; i < 64; i++){
    notes[i] = " ";
  }
  changeTempo();
  ABCJS.renderAbc("paper","M:4/4\nL:1/8\nK:C\n " + `"C"` + notes[0] + notes[1] + notes[2] + notes[3] + notes[4] + notes[5] + notes[6]+ notes[7] + "|" + `"F"` + notes[8] + notes[9] + notes[10] + notes[11] + notes[12] + notes[13] + notes[14]+ notes[15] + "|" + `"G"` + notes[16] + notes[17] + notes[18] + notes[19] + notes[20] + notes[21] + notes[22]+ notes[23] + "|" + `"C"` + notes[24] + notes[25] + notes[26] + notes[27] + notes[28] + notes[29] + notes[30]+ notes[31] + "|" + '\n' +`"C"` + notes[32] + notes[33] + notes[34] + notes[35] + notes[36] + notes[37] + notes[38] + notes[39] + "|" + `"Am"` + notes[40] + notes[41] + notes[42] + notes[43] + notes[44] + notes[45] + notes[46] + notes[47] + "|" + `"Dm"` + notes[48] + notes[49] + notes[50] + notes[51] + `"G7"` + notes[52] + notes[53] + notes[54] + notes[55] + "|" + `"C"` + notes[56] + notes[57] + notes[58] + notes[59] + notes[60] + notes[61] + notes[62] + notes[63] + "|]",{add_classes: true,responsive: "resize",paddingtop:"18",paddingbottom:"8"});
}

function borderReset(){
  document.getElementById("tata").style.borderColor = "black";
  document.getElementById("tan").style.borderColor = "black";
  document.getElementById("ta_n").style.borderColor = "black";
  document.getElementById("ta__n").style.borderColor = "black";
}


//全体で使う変数や設定など
    const tempo_category = document.getElementById("tempo_category");
    const play_mode = document.getElementById("play_mode");
    const measure_edit = document.getElementById("measureEdit");
    const notes = new Array(); 
    const kachi = new Audio('audio/kachi.mp3');
    let notesCount = 0;


//リズム再生
document.getElementById("tan").addEventListener("click", function() {
  kachi.play();
  borderReset();
  document.getElementById("tan").style.borderColor = "lightblue";
}, false);

document.getElementById("tata").addEventListener("click", function() {
  kachi.play();
  borderReset();
  document.getElementById("tata").style.borderColor = "lightgreen";
}, false);

document.getElementById("ta__n").addEventListener("click", function() {
  kachi.play();
  borderReset();
  document.getElementById("ta__n").style.borderColor = "lightpink";
}, false);

document.getElementById("ta_n").addEventListener("click", function() {
  kachi.play();
  borderReset();
  document.getElementById("ta_n").style.borderColor = "orange";
}, false);


function melodyAndChordRenderMidi(bpm) {
  ABCJS.renderMidi( "audio","M:4/4\nL:1/8\nK:C\nV:1\n" + `"C"` + `${notes[0]}` + notes[1] + notes[2] + notes[3] + notes[4] + notes[5] + notes[6]+ notes[7] + "|" + `"F"` + `${notes[8]}` + notes[9] + notes[10] + notes[11] + notes[12] + notes[13] + notes[14]+ notes[15] + "|" + `"G"` + `${notes[16]}` + notes[17] + notes[18] + notes[19] + notes[20] + notes[21] + notes[22]+ notes[23] + "|" + `"C"` + `${notes[24]}` + notes[25] + notes[26] + notes[27] + notes[28] + notes[29] + notes[30]+ notes[31] + "|" + `"C"` + '\n' + `${notes[32]}` + notes[33] + notes[34] + notes[35] + notes[36] + notes[37] + notes[38] + notes[39] + "|" + `"Am"` + `${notes[40]}` + notes[41] + notes[42] + notes[43] + notes[44] + notes[45] + notes[46] + notes[47] + "|" + `"Dm"` + `${notes[48]}` + notes[49] + notes[50] + notes[51] + notes[52] + notes[53] + notes[54] + notes[55] + "|" + `"C"` + `${notes[56]}` + notes[57] + notes[58] + notes[59] + notes[60] + notes[61] + notes[62] + notes[63] + "||" +
        "\nV:2\n" + `"C"[C4E4G4c4]"C"[C4E4G4c4]` + "|" + `"F"[F4A4c4f4]"F"[F4A4c4f4]` + "|" + `"G"[G4B4D4d4]"G"[G4B4D4d4]` +  "|" + `"C"[C4E4G4c4]"C"[C4E4G4c4]` + "|" + `"C"[C4E4G4c4]"C"[C4E4G4c4]` + "|" + `"Am"[C4E4A4a4]"Am"[C4E4A4a4]` + "|" + `"Dm"[D4F4A4d4]"G7"[D4F4G4B4c4]` +  "|" + `"C"[C4E4G4c4]"C"[C4E4G4c4]` + "||",{generateDownload: true,qpm:bpm,chordsOff:true});
}

function melodyRenderMidi(bpm) {
  ABCJS.renderMidi( "audio","M:4/4\nL:1/8\nK:C\n " + `"C"` + `${notes[0]}` + notes[1] + notes[2] + notes[3] + notes[4] + notes[5] + notes[6]+ notes[7] + "|" + `"F"` + `${notes[8]}` + notes[9] + notes[10] + notes[11] + notes[12] + notes[13] + notes[14]+ notes[15] + "|" + `"G"` + `${notes[16]}` + notes[17] + notes[18] + notes[19] + notes[20] + notes[21] + notes[22]+ notes[23] + "|" + `"C"` + `${notes[24]}` + notes[25] + notes[26] + notes[27] + notes[28] + notes[29] + notes[30]+ notes[31] + "|" + `"C"` + '\n' + `${notes[32]}` + notes[33] + notes[34] + notes[35] + notes[36] + notes[37] + notes[38] + notes[39] + "|" + `"Am"` + `${notes[40]}` + notes[41] + notes[42] + notes[43] + notes[44] + notes[45] + notes[46] + notes[47] + "|" + `"Dm"` + `${notes[48]}` + notes[49] + notes[50] + notes[51] + notes[52] + notes[53] + notes[54] + notes[55] + "|" + `"C"` + `${notes[56]}` + notes[57] + notes[58] + notes[59] + notes[60] + notes[61] + notes[62] + notes[63] + "||",{generateDownload: true,qpm:bpm,chordsOff:true});
}

function chordRenderMidi(bpm) {
  ABCJS.renderMidi( "audio","M:4/4\nL:1/8\nK:C\nV:1\n" + `"C"[C4E4G4c4]"C"[C4E4G4c4]` + "|" + `"F"[F4A4c4f4]"F"[F4A4c4f4]` + "|" + `"G"[G4B4D4d4]"G"[G4B4D4d4]` +  "|" + `"C"[C4E4G4c4]"C"[C4E4G4c4]` + "|" + `"C"[C4E4G4c4]"C"[C4E4G4c4]` + "|" + `"Am"[C4E4A4a4]"Am"[C4E4A4a4]` + "|" + `"Dm"[D4F4A4d4]"G7"[D4F4G4B4c4]` +  "|" + `"C"[C4E4G4c4]"C"[C4E4G4c4]` + "||",{generateDownload: true,qpm:bpm,chordsOff:true});
}


//テンポ切り替え
tempo_category.onchange = changeTempo;
play_mode.onchange = changeTempo;

function changeTempo(){
  switch (tempo_category.value){
  case "tempo_60":
    switch (play_mode.value){
      case "play":
        melodyAndChordRenderMidi(60);
          break; 
      case "only_melody":
        melodyRenderMidi(60);
          break; 
      case "only_chord":
        chordRenderMidi(60);
          break;
      default: 
    }    
      break;
  case "tempo_80":
    switch (play_mode.value){
      case "play":
      melodyAndChordRenderMidi(80);
          break; 
      case "only_melody":
      melodyRenderMidi(80);
          break; 
      case "only_chord":
      chordRenderMidi(80);
          break;
      default: 
    }    
      break;
  case "tempo_100":
    switch (play_mode.value){
      case "play":
      melodyAndChordRenderMidi(100);
          break;  
      case "only_melody":
      melodyRenderMidi(100);
          break;
      case "only_chord":
      chordRenderMidi(100);
          break;
      default: 
    }  
      break;
  case "tempo_120":
    switch (play_mode.value){
      case "play":
      melodyAndChordRenderMidi(120);
      break;  
      case "only_melody":
      melodyRenderMidi(120);
          break;
      case "only_chord":
      chordRenderMidi(120);
          break;
      default: 
    }    
      break;    
  case "tempo_140":
    switch (play_mode.value){
      case "play":
      melodyAndChordRenderMidi(140);
      break;  
      case "only_melody":
      melodyRenderMidi(140);
          break;
      case "only_chord":
      chordRenderMidi(140);
          break;
      default: 
    }    
      break;    
  case "tempo_160":
    switch (play_mode.value){
      case "play":
      melodyAndChordRenderMidi(160);
      break;  
      case "only_melody":
      melodyRenderMidi(160);
          break;
      case "only_chord":
      chordRenderMidi(160);
          break;
      default: 
    }       
      break;      
  default: 
  }  
}

//楽譜表示
function displayNote(){
  changeTempo();
  ABCJS.renderAbc("paper","M:4/4\nL:1/8\nK:C\n " + `"C"` + notes[0] + notes[1] + notes[2] + notes[3] + notes[4] + notes[5] + notes[6]+ notes[7] + "|" + `"F"` + notes[8] + notes[9] + notes[10] + notes[11] + notes[12] + notes[13] + notes[14]+ notes[15] + "|" + `"G"` + notes[16] + notes[17] + notes[18] + notes[19] + notes[20] + notes[21] + notes[22]+ notes[23] + "|" + `"C"` + notes[24] + notes[25] + notes[26] + notes[27] + notes[28] + notes[29] + notes[30]+ notes[31] + "|" + '\n' +`"C"` +  notes[32] + notes[33] + notes[34] + notes[35] + notes[36] + notes[37] + notes[38] + notes[39] + "|" + `"Am"` + notes[40] + notes[41] + notes[42] + notes[43] + notes[44] + notes[45] + notes[46] + notes[47] + "|" + `"Dm"` + notes[48] + notes[49] + notes[50] + notes[51] + `"G7"` + notes[52] + notes[53] + notes[54] + notes[55] + "|" + `"C"` + notes[56] + notes[57] + notes[58] + notes[59] + notes[60] + notes[61] + notes[62] + notes[63] + "|]",{add_classes: true,responsive: "resize",paddingtop:"0",paddingbottom:"8"});
}  

//楽譜表示切り替え
//ド→C レ→D ミ→E ファ→F ソ→G ラ→A シ→B ド→c レ→d ミ→e


//音源
function playSingleNote(note,beat) {
  const synth = new Tone.Synth().toDestination();
  synth.triggerAttackRelease(note, beat);
}

let eighthNote = document.getElementById("eighthNote");
let quarterNote = document.getElementById("quarterNote");
let dottedQuarterNote = document.getElementById("dottedQuarterNote");
let halfNote = document.getElementById("halfNote");

measure_edit.onchange = measureEdit;

measure_edit.style.display = "none";


function measureEdit(){
  switch (measure_edit.value){
  case "measure1":
    notesCount = 0;
    notes[0] = "";
    notes[1] = "";
    notes[2] = "";
    notes[3] = "";
    notes[4] = "";
    notes[5] = "";
    notes[6] = "";
    notes[7] = "";
    displayNote();
  break;
  case "measure2": 
    notesCount = 8;
    notes[8] = "";
    notes[9] = "";
    notes[10] = "";
    notes[11] = "";
    notes[12] = "";
    notes[13] = "";
    notes[14] = "";
    notes[15] = "";
    displayNote();
  break;
  case "measure3":
    notesCount = 16;
    notes[16] = "";
    notes[17] = "";
    notes[18] = "";
    notes[19] = "";
    notes[20] = "";
    notes[21] = "";
    notes[22] = "";
    notes[23] = "";
    displayNote();
  break;
  case "measure4": 
    notesCount = 24;
    notes[24] = "";
    notes[25] = "";
    notes[26] = "";
    notes[27] = "";
    notes[28] = "";
    notes[29] = "";
    notes[30] = "";
    notes[31] = "";
    displayNote();
  break;
  case "measure5":
    notesCount = 32;
    notes[32] = "";
    notes[33] = "";
    notes[34] = "";
    notes[35] = "";
    notes[36] = "";
    notes[37] = "";
    notes[38] = "";
    notes[39] = "";
    displayNote();
  break;
  case "measure6":
    notesCount = 40;
    notes[40] = "";
    notes[41] = "";
    notes[42] = "";
    notes[43] = "";
    notes[44] = "";
    notes[45] = "";
    notes[46] = "";
    notes[47] = "";
    displayNote(); 
  break;
  case "measure7":
    notesCount = 48;
    notes[48] = "";
    notes[49] = "";
    notes[50] = "";
    notes[51] = "";
    notes[52] = "";
    notes[53] = "";
    notes[54] = "";
    notes[55] = "";
    displayNote();
  break;
  case "measure8": 
    notesCount = 56;
    notes[56] = "";
    notes[57] = "";
    notes[58] = "";
    notes[59] = "";
    notes[60] = "";
    notes[61] = "";
    notes[62] = "";
    notes[63] = "";
    displayNote();
  break;
  default:
  }
}


const wrong = new Audio('audio/wrong.mp3');

function soundAndDisplayNote(sound,display) {
  if(notesCount >= 56){
        measure_edit.style.display = "block";
  }

  if(eighthNote.checked){
      if(notesCount >= 64){
        wrong.play();
      }
      else if(measure_edit.value != "measureEdit"){
        if(measure_edit.value == "measure1"){
          if(notesCount == 0 || notesCount%8 != 0){
            if(notesCount%2 == 0){
              playSingleNote(sound,"8n");
              notes[notesCount] = display;
              notesCount++;
            }
            else{
              playSingleNote(sound,"8n");
              notes[notesCount] = display + " ";
              notesCount++;
            }
          }
        }
        if(measure_edit.value == "measure2"){
          if(notesCount == 8 || notesCount%8 != 0){
            if(notesCount%2 == 0){
              playSingleNote(sound,"8n");
              notes[notesCount] = display;
              notesCount++;
            }
            else{
              playSingleNote(sound,"8n");
              notes[notesCount] = display + " ";
              notesCount++;
            }
          }
        }
        if(measure_edit.value == "measure3"){
          if(notesCount == 16 || notesCount%8 != 0){
            if(notesCount%2 == 0){
              playSingleNote(sound,"8n");
              notes[notesCount] = display;
              notesCount++;
            }
            else{
              playSingleNote(sound,"8n");
              notes[notesCount] = display + " ";
              notesCount++;
            }
          }
        }
        if(measure_edit.value == "measure4"){
          if(notesCount == 24 || notesCount%8 != 0){
            if(notesCount%2 == 0){
              playSingleNote(sound,"8n");
              notes[notesCount] = display;
              notesCount++;
            }
            else{
              playSingleNote(sound,"8n");
              notes[notesCount] = display + " ";
              notesCount++;
            }
          }
        }
        if(measure_edit.value == "measure5"){
          if(notesCount == 32 || notesCount%8 != 0){
            if(notesCount%2 == 0){
              playSingleNote(sound,"8n");
              notes[notesCount] = display;
              notesCount++;
            }
            else{
              playSingleNote(sound,"8n");
              notes[notesCount] = display + " ";
              notesCount++;
            }
          }
        }
        if(measure_edit.value == "measure6"){
          if(notesCount == 40 || notesCount%8 != 0){
            if(notesCount%2 == 0){
              playSingleNote(sound,"8n");
              notes[notesCount] = display;
              notesCount++;
            }
            else{
              playSingleNote(sound,"8n");
              notes[notesCount] = display + " ";
              notesCount++;
            }
          }
        }
        if(measure_edit.value == "measure7"){
          if(notesCount == 48 || notesCount%8 != 0){
            if(notesCount%2 == 0){
              playSingleNote(sound,"8n");
              notes[notesCount] = display;
              notesCount++;
            }
            else{
              playSingleNote(sound,"8n");
              notes[notesCount] = display + " ";
              notesCount++;
            }
          }
        }
        if(measure_edit.value == "measure8"){
          if(notesCount == 56 || notesCount%8 != 0){
            if(notesCount%2 == 0){
              playSingleNote(sound,"8n");
              notes[notesCount] = display;
              notesCount++;
            }
            else{
              playSingleNote(sound,"8n");
              notes[notesCount] = display + " ";
              notesCount++;
            }
          }
        }
      }
      else if(notesCount%2 == 0){
        playSingleNote(sound,"8n");
        notes[notesCount] = display;
        notesCount++;
      }
      else{
        playSingleNote(sound,"8n");
        notes[notesCount] = display + " ";
        notesCount++;
      }
    }

    else if(quarterNote.checked){
      if(notesCount%8 == 7 || notesCount >= 64){
        wrong.play();
      }
      else if(measure_edit.value != "measureEdit"){
        if(measure_edit.value == "measure1"){
          if(notesCount == 0 || notesCount%8 != 0){
          playSingleNote(sound,"4n");
          notes[notesCount] = display + "2";
          notesCount+=2;
          }
        }
        if(measure_edit.value == "measure2"){
          if(notesCount == 8 || notesCount%8 != 0){
          playSingleNote(sound,"4n");
          notes[notesCount] = display + "2";
          notesCount+=2;
          }
        }
        if(measure_edit.value == "measure3"){
          if(notesCount == 16 || notesCount%8 != 0){
          playSingleNote(sound,"4n");
          notes[notesCount] = display + "2";
          notesCount+=2;
          }
        }
        if(measure_edit.value == "measure4"){
          if(notesCount == 24 || notesCount%8 != 0){
          playSingleNote(sound,"4n");
          notes[notesCount] = display + "2";
          notesCount+=2;
          }
        }
        if(measure_edit.value == "measure5"){
          if(notesCount == 32 || notesCount%8 != 0){
          playSingleNote(sound,"4n");
          notes[notesCount] = display + "2";
          notesCount+=2;
          }
        }
        if(measure_edit.value == "measure6"){
          if(notesCount == 40 || notesCount%8 != 0){
          playSingleNote(sound,"4n");
          notes[notesCount] = display + "2";
          notesCount+=2;
          }
        }
        if(measure_edit.value == "measure7"){
          if(notesCount == 48 || notesCount%8 != 0){
          playSingleNote(sound,"4n");
          notes[notesCount] = display + "2";
          notesCount+=2;
          }
        }
        if(measure_edit.value == "measure8"){
          if(notesCount == 56 || notesCount%8 != 0){
          playSingleNote(sound,"4n");
          notes[notesCount] = display + "2";
          notesCount+=2;
          }
        }
      }
      else{
        playSingleNote(sound,"4n");
        notes[notesCount] = display + "2";
        notesCount+=2;
      }
    }
    else if(dottedQuarterNote.checked){
      if(notesCount%8 == 6 ||notesCount%8 == 7 || notesCount >= 64){
        wrong.play();
      }

      else if(measure_edit.value != "measureEdit"){
        if(measure_edit.value == "measure1"){
          if(notesCount == 0 || notesCount%8 != 0){
            playSingleNote(sound,"3n");
            notes[notesCount] = display + "3";
            notesCount+=3;
          }
        }
        if(measure_edit.value == "measure2"){
          if(notesCount == 8 || notesCount%8 != 0){
            playSingleNote(sound,"3n");
            notes[notesCount] = display + "3";
            notesCount+=3;
          }
        }
        if(measure_edit.value == "measure3"){
          if(notesCount == 16 || notesCount%8 != 0){
            playSingleNote(sound,"3n");
            notes[notesCount] = display + "3";
            notesCount+=3;
          }
        }
        if(measure_edit.value == "measure4"){
          if(notesCount == 24 || notesCount%8 != 0){
            playSingleNote(sound,"3n");
            notes[notesCount] = display + "3";
            notesCount+=3;
          }
        }
        if(measure_edit.value == "measure5"){
          if(notesCount == 32 || notesCount%8 != 0){
            playSingleNote(sound,"3n");
            notes[notesCount] = display + "3";
            notesCount+=3;
          }
        }
        if(measure_edit.value == "measure6"){
          if(notesCount == 40 || notesCount%8 != 0){
            playSingleNote(sound,"3n");
            notes[notesCount] = display + "3";
            notesCount+=3;
          }
        }
        if(measure_edit.value == "measure7"){
          if(notesCount == 48 || notesCount%8 != 0){
            playSingleNote(sound,"3n");
            notes[notesCount] = display + "3";
            notesCount+=3;
          }
        }
        if(measure_edit.value == "measure8"){
          if(notesCount == 56 || notesCount%8 != 0){
            playSingleNote(sound,"3n");
            notes[notesCount] = display + "3";
            notesCount+=3;
          }
        }
      }
      
      else{
        playSingleNote(sound,"3n");
        notes[notesCount] = display + "3";
        notesCount+=3;
      }
    }
    else if(halfNote.checked){
      if(notesCount%8 == 5 || notesCount%8 == 6 || notesCount%8 == 7 || notesCount >= 64){
        wrong.play();
      }
      else if(measure_edit.value != "measureEdit"){
        if(measure_edit.value == "measure1"){
          if(notesCount == 0 || notesCount%8 != 0){
            playSingleNote(sound,"2n");
            notes[notesCount] = display + "4";
            notesCount+=4;
          }
        }
        if(measure_edit.value == "measure2"){
          if(notesCount == 8 || notesCount%8 != 0){
            playSingleNote(sound,"2n");
            notes[notesCount] = display + "4";
            notesCount+=4;
          }
        }
        if(measure_edit.value == "measure3"){
          if(notesCount == 16 || notesCount%8 != 0){
            playSingleNote(sound,"2n");
            notes[notesCount] = display + "4";
            notesCount+=4;
          }
        }
        if(measure_edit.value == "measure4"){
          if(notesCount == 24 || notesCount%8 != 0){
            playSingleNote(sound,"2n");
            notes[notesCount] = display + "4";
            notesCount+=4;
          }
        }
        if(measure_edit.value == "measure5"){
          if(notesCount == 32 || notesCount%8 != 0){
            playSingleNote(sound,"2n");
            notes[notesCount] = display + "4";
            notesCount+=4;
          }
        }
        if(measure_edit.value == "measure6"){
          if(notesCount == 40 || notesCount%8 != 0){
            playSingleNote(sound,"2n");
            notes[notesCount] = display + "4";
            notesCount+=4;
          }
        }
        if(measure_edit.value == "measure7"){
          if(notesCount == 48 || notesCount%8 != 0){
            playSingleNote(sound,"2n");
            notes[notesCount] = display + "4";
            notesCount+=4;
          }
        }
        if(measure_edit.value == "measure8"){
          if(notesCount == 56 || notesCount%8 != 0){
            playSingleNote(sound,"2n");
            notes[notesCount] = display + "4";
            notesCount+=4;
          }
        }
      }
      else{
        playSingleNote(sound,"2n");
        notes[notesCount] = display + "4";
        notesCount+=4;
      }
    }
}

document.getElementById("eighthRest").addEventListener("click", function() {
  if(notesCount >= 64){
        wrong.play();
      }
  else if(notes[notesCount - 1] == " z"){
    notes[notesCount - 1] = "z2";
    notesCount++;
    displayNote();
  }
  else{
    notes[notesCount] = " z";
    notesCount++;
    displayNote();
  }
}, false);

document.getElementById("quarterRest").addEventListener("click", function() {
  if(notesCount%8 == 7 || notesCount >= 64){
        wrong.play();
      }
      else{
        notes[notesCount] = "z2";
        notesCount+=2;
        displayNote();
      }
}, false);



measure_edit.onchange = measureEdit;

function measureEdit(){
  switch (measure_edit.value){
  case "measure1":
    notesCount = 0;
    notes[0] = "";
    notes[1] = "";
    notes[2] = "";
    notes[3] = "";
    notes[4] = "";
    notes[5] = "";
    notes[6] = "";
    notes[7] = "";
    displayNote();
  break;
  case "measure2": 
    notesCount = 8;
    notes[8] = "";
    notes[9] = "";
    notes[10] = "";
    notes[11] = "";
    notes[12] = "";
    notes[13] = "";
    notes[14] = "";
    notes[15] = "";
    displayNote();
  break;
  case "measure3":
    notesCount = 16;
    notes[16] = "";
    notes[17] = "";
    notes[18] = "";
    notes[19] = "";
    notes[20] = "";
    notes[21] = "";
    notes[22] = "";
    notes[23] = "";
    displayNote();
  break;
  case "measure4": 
    notesCount = 24;
    notes[24] = "";
    notes[25] = "";
    notes[26] = "";
    notes[27] = "";
    notes[28] = "";
    notes[29] = "";
    notes[30] = "";
    notes[31] = "";
    displayNote();
  break;
  case "measure5":
    notesCount = 32;
    notes[32] = "";
    notes[33] = "";
    notes[34] = "";
    notes[35] = "";
    notes[36] = "";
    notes[37] = "";
    notes[38] = "";
    notes[39] = "";
    displayNote();
  break;
  case "measure6":
    notesCount = 40;
    notes[40] = "";
    notes[41] = "";
    notes[42] = "";
    notes[43] = "";
    notes[44] = "";
    notes[45] = "";
    notes[46] = "";
    notes[47] = "";
    displayNote(); 
  break;
  case "measure7":
    notesCount = 48;
    notes[48] = "";
    notes[49] = "";
    notes[50] = "";
    notes[51] = "";
    notes[52] = "";
    notes[53] = "";
    notes[54] = "";
    notes[55] = "";
    displayNote();
  break;
  case "measure8": 
    notesCount = 56;
    notes[56] = "";
    notes[57] = "";
    notes[58] = "";
    notes[59] = "";
    notes[60] = "";
    notes[61] = "";
    notes[62] = "";
    notes[63] = "";
    displayNote();
  break;
  default:
  }
}

const eighthNoteArray = ["C","D","E","F","G","A","B","c","d","e","C ","D ","E ","F ","G ","A ","B ","c ","d ","e "];
const quarterNoteArray = ["C2","D2","E2","F2","G2","A2","B2","c2","d2","e2"];
const dottedQuarterNoteArray = ["C3","D3","E3","F3","G3","A3","B3","c3","d3","e3"];
const halfNoteArray = ["C4","D4","E4","F4","G4","A4","B4","c4","d4","e4"];

document.getElementById("oneBack").addEventListener("click", function() {
  if(notesCount == 0){
    wrong.play();
  }
  else if(eighthNoteArray.includes(notes[notesCount-1])){
    notes[notesCount-1] = "";
    notesCount--;
    displayNote();
  }
  else if(quarterNoteArray.includes(notes[notesCount-2])){
    notes[notesCount-2] = "";
    notesCount-=2;
    displayNote();
  }
  else if(dottedQuarterNoteArray.includes(notes[notesCount-3])){
    notes[notesCount-3] = "";
    notesCount-=3;
    displayNote();
  }
  else if(halfNoteArray.includes(notes[notesCount-4])){
    notes[notesCount-4] = "";
    notesCount-=4;
    displayNote();
  }
  else if(notes[notesCount-1] == " z"){
    notes[notesCount-1] = "";
    notesCount--;
    displayNote();
  }
  else if(notes[notesCount-2] == "z2"){
    notes[notesCount-2] = "";
    notesCount-=2;
    displayNote();
  }
}, false);

document.getElementById("piano").addEventListener("click", function() {
    displayNote();
}, false);


//鍵盤音階再生
document.getElementById("do").addEventListener("click", function() {
    soundAndDisplayNote("C4","C");
}, false);

  document.getElementById("re").addEventListener("click", function() {
    soundAndDisplayNote("D4","D");
}, false);

  document.getElementById("mi").addEventListener("click", function() {
    soundAndDisplayNote("E4","E");
}, false);

  document.getElementById("fa").addEventListener("click", function() {
    soundAndDisplayNote("F4","F");
}, false);

  document.getElementById("so").addEventListener("click", function() {
    soundAndDisplayNote("G4","G");
}, false);

  document.getElementById("ra").addEventListener("click", function() {
    soundAndDisplayNote("A4","A");
}, false);

  document.getElementById("shi").addEventListener("click", function() {
    soundAndDisplayNote("B4","B");
}, false);

  document.getElementById("do_high").addEventListener("click", function() {
    soundAndDisplayNote("C5","c");
}, false);

  document.getElementById("re_high").addEventListener("click", function() {
    soundAndDisplayNote("D5","d");
}, false);

  document.getElementById("mi_high").addEventListener("click", function() {
    soundAndDisplayNote("E5","e");
}, false);
</script>
</body>
</html>
